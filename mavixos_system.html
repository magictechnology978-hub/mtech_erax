<!DOCTYPE html>
<html lang="ar" dir="rtl" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مدير الطلبات والعملاء - Tabs Edition</title>
    <!-- Google Fonts: Cairo -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Cairo', sans-serif;
            background-color: #0f172a; 
            color: #f1f5f9;
        }
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 1.25rem;
        }
        input, select, textarea {
            background: #1e293b !important;
            border: 1px solid #334155 !important;
            color: white !important;
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            outline: none;
            transition: all 0.2s;
        }
        input:focus, textarea:focus {
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 10px;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="min-h-screen">

    <div class="flex flex-col lg:flex-row min-h-screen">
        
        <!-- Sidebar -->
        <aside class="lg:w-96 w-full p-6 border-l border-slate-800 shrink-0 h-screen flex flex-col overflow-hidden bg-slate-900/50">
            <div class="flex items-center gap-3 mb-8">
                <div class="bg-blue-600 p-2 rounded-lg text-white">
                    <i data-lucide="layout-dashboard"></i>
                </div>
                <h1 class="text-xl font-bold tracking-tight">إدارة العمليات</h1>
            </div>

            <!-- Navigation Tabs Buttons -->
            <div class="flex gap-2 mb-6 p-1 bg-slate-800 rounded-xl">
                <button onclick="showTab('customer-tab')" id="btn-customer-tab" class="flex-1 py-2 px-3 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 bg-blue-600 text-white">
                    <i data-lucide="user" class="w-4 h-4"></i>
                    العميل
                </button>
                <button onclick="showTab('product-tab')" id="btn-product-tab" class="flex-1 py-2 px-3 rounded-lg text-sm font-bold transition-all flex items-center justify-center gap-2 text-slate-400 hover:bg-slate-700">
                    <i data-lucide="shopping-bag" class="w-4 h-4"></i>
                    المنتج
                </button>
            </div>

            <form id="order-form" class="flex-1 flex flex-col overflow-hidden">
                <div class="flex-1 overflow-y-auto custom-scrollbar px-1">
                    
                    <!-- Customer Tab Content -->
                    <div id="customer-tab" class="tab-content active space-y-4">
                        <div class="glass-card p-5 border-r-4 border-r-blue-500">
                            <h3 class="font-bold mb-4 text-blue-400 flex items-center gap-2">
                                <i data-lucide="info"></i> بيانات العميل الأساسية
                            </h3>
                            <div class="space-y-4 text-sm">
                                <div class="space-y-1">
                                    <label class="text-slate-400">اسم العميل</label>
                                    <input type="text" id="customer-name" class="w-full" placeholder="اسم العميل بالكامل" required>
                                </div>
                                <div class="space-y-1">
                                    <label class="text-slate-400">رقم الهاتف</label>
                                    <input type="tel" id="customer-phone" class="w-full" placeholder="01xxxxxxxxx">
                                </div>
                                <div class="space-y-1">
                                    <label class="text-slate-400">العنوان بالتفصيل</label>
                                    <textarea id="customer-address" class="w-full h-24 resize-none" placeholder="شارع، منطقة، مدينة..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Product Tab Content -->
                    <div id="product-tab" class="tab-content space-y-4">
                        <div class="glass-card p-5 border-r-4 border-r-emerald-500">
                            <h3 class="font-bold mb-4 text-emerald-400 flex items-center gap-2">
                                <i data-lucide="box"></i> تفاصيل الشحنة والماليات
                            </h3>
                            <div class="space-y-4 text-sm">
                                <div class="space-y-1">
                                    <label class="text-slate-400">اسم المنتج</label>
                                    <input type="text" id="product-name" class="w-full" placeholder="مثلاً: سماعة بلوتوث" required>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-slate-400">الكمية</label>
                                        <input type="number" id="quantity" value="1" min="1" class="w-full text-center">
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-slate-400">سعر البيع</label>
                                        <input type="number" id="selling-price" class="w-full" placeholder="0" required>
                                    </div>
                                </div>
                                <div class="grid grid-cols-2 gap-3">
                                    <div class="space-y-1">
                                        <label class="text-slate-400">التكلفة (للقطعة)</label>
                                        <input type="number" id="cost-price" class="w-full" placeholder="0" required>
                                    </div>
                                    <div class="space-y-1">
                                        <label class="text-slate-400">طريقة الدفع</label>
                                        <select id="payment-method" class="w-full">
                                            <option value="Cash">كاش</option>
                                            <option value="Instapay">Instapay</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Action Button at Bottom of Sidebar -->
                <div class="pt-4 mt-auto border-t border-slate-800">
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold transition-all flex items-center justify-center gap-2 shadow-lg shadow-blue-900/40 group">
                        <i data-lucide="send" class="w-5 h-5 group-hover:translate-x-[-4px] transition-transform"></i>
                        تأكيد وحفظ الطلب
                    </button>
                    
                    <div class="grid grid-cols-2 gap-2 mt-3">
                        <button type="button" onclick="exportData()" class="flex items-center justify-center gap-1 p-2 rounded-lg bg-slate-800 hover:bg-slate-700 text-xs text-slate-300 transition">
                            <i data-lucide="download" class="w-3 h-3 text-green-500"></i> تصدير
                        </button>
                        <button type="button" onclick="clearAllData()" class="flex items-center justify-center gap-1 p-2 rounded-lg bg-slate-800 hover:bg-red-900/20 text-xs text-red-400 transition">
                            <i data-lucide="trash-2" class="w-3 h-3 text-red-500"></i> مسح الكل
                        </button>
                    </div>
                </div>
            </form>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 p-6 lg:p-10 space-y-8 overflow-y-auto custom-scrollbar bg-slate-950/20">
            
            <!-- Dashboard Stats -->
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">
                <div class="glass-card p-6 flex items-center gap-4 border-b-2 border-b-blue-500">
                    <div class="p-3 bg-blue-500/10 rounded-2xl text-blue-500">
                        <i data-lucide="users" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <p class="text-slate-400 text-xs font-bold">إجمالي الطلبات</p>
                        <h2 id="stat-total-orders" class="text-2xl font-bold">0</h2>
                    </div>
                </div>
                <div class="glass-card p-6 flex items-center gap-4 border-b-2 border-b-green-500">
                    <div class="p-3 bg-green-500/10 rounded-2xl text-green-500">
                        <i data-lucide="trending-up" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <p class="text-slate-400 text-xs font-bold">صافي الأرباح</p>
                        <h2 id="stat-total-profit" class="text-2xl font-bold text-green-400">0</h2>
                    </div>
                </div>
                <div class="glass-card p-6 flex items-center gap-4 border-b-2 border-b-purple-500">
                    <div class="p-3 bg-purple-500/10 rounded-2xl text-purple-500">
                        <i data-lucide="smartphone" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <p class="text-slate-400 text-xs font-bold">تحصيلات Instapay</p>
                        <h2 id="stat-instapay" class="text-2xl font-bold">0</h2>
                    </div>
                </div>
                <div class="glass-card p-6 flex items-center gap-4 border-b-2 border-b-orange-500">
                    <div class="p-3 bg-orange-500/10 rounded-2xl text-orange-500">
                        <i data-lucide="banknote" class="w-8 h-8"></i>
                    </div>
                    <div>
                        <p class="text-slate-400 text-xs font-bold">تحصيلات كاش</p>
                        <h2 id="stat-cash" class="text-2xl font-bold">0</h2>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                <!-- Data Table Section -->
                <div class="xl:col-span-2 glass-card overflow-hidden flex flex-col min-h-[500px]">
                    <div class="p-6 border-b border-slate-800 flex flex-col sm:flex-row justify-between items-center gap-4 bg-slate-800/20">
                        <div class="flex items-center gap-2">
                            <i data-lucide="clipboard-list" class="text-blue-500"></i>
                            <h3 class="font-bold text-lg">سجل العمليات اليومية</h3>
                        </div>
                        <div class="relative flex-1 max-w-xs w-full">
                            <i data-lucide="search" class="absolute left-3 top-3 w-4 h-4 text-slate-500"></i>
                            <input type="text" id="search-bar" placeholder="ابحث باسم العميل أو المنتج..." class="w-full pl-10 py-2 text-xs">
                        </div>
                    </div>
                    <div class="overflow-x-auto flex-1 custom-scrollbar">
                        <table class="w-full text-right">
                            <thead class="bg-slate-800/50 text-slate-400 text-[10px] uppercase tracking-wider">
                                <tr>
                                    <th class="p-4">تفاصيل العميل والمنتج</th>
                                    <th class="p-4">بيانات الاتصال</th>
                                    <th class="p-4 text-center">الكمية</th>
                                    <th class="p-4">صافي الربح</th>
                                    <th class="p-4">الدفع</th>
                                    <th class="p-4">إجراء</th>
                                </tr>
                            </thead>
                            <tbody id="orders-table-body" class="divide-y divide-slate-800/50">
                                <!-- JS content -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="glass-card p-6 flex flex-col h-full bg-slate-900/40">
                    <div class="flex items-center gap-2 mb-6">
                        <i data-lucide="bar-chart-big" class="text-pink-500"></i>
                        <h3 class="font-bold text-lg text-slate-200">الأكثر مبيعاً (أرباح)</h3>
                    </div>
                    <div class="flex-1 min-h-[300px] flex items-center justify-center">
                        <canvas id="profitChart"></canvas>
                    </div>
                    <div id="no-data-chart" class="hidden text-center text-slate-500 text-sm py-20">لا توجد بيانات كافية للرسم</div>
                </div>
            </div>
        </main>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-6 left-6 glass-card px-6 py-4 flex items-center gap-3 transform translate-y-20 opacity-0 transition-all duration-300 z-50 shadow-2xl shadow-blue-500/20">
        <div id="toast-icon" class="bg-green-500/20 p-1 rounded text-green-500"><i data-lucide="check" class="w-4 h-4"></i></div>
        <span id="toast-msg" class="text-sm font-bold">تم الحفظ</span>
    </div>

    <script>
        let orders = JSON.parse(localStorage.getItem('tabbed_business_orders')) || [];
        let chart = null;

        function init() {
            lucide.createIcons();
            renderAll();
        }

        // Tab System
        function showTab(tabId) {
            // Hide all
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('[id^="btn-"]').forEach(b => {
                b.classList.remove('bg-blue-600', 'text-white');
                b.classList.add('text-slate-400', 'hover:bg-slate-700');
            });

            // Show active
            document.getElementById(tabId).classList.add('active');
            const activeBtn = document.getElementById('btn-' + tabId);
            activeBtn.classList.remove('text-slate-400', 'hover:bg-slate-700');
            activeBtn.classList.add('bg-blue-600', 'text-white');
            
            lucide.createIcons();
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('translate-y-20', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000);
        }

        document.getElementById('order-form').onsubmit = (e) => {
            e.preventDefault();
            
            const customerName = document.getElementById('customer-name').value;
            const customerPhone = document.getElementById('customer-phone').value;
            const customerAddress = document.getElementById('customer-address').value;
            const productName = document.getElementById('product-name').value;
            const qty = parseInt(document.getElementById('quantity').value);
            const sell = parseFloat(document.getElementById('selling-price').value);
            const cost = parseFloat(document.getElementById('cost-price').value);
            const method = document.getElementById('payment-method').value;

            const profit = (sell - cost) * qty;

            orders.unshift({
                id: Date.now(),
                customerName, customerPhone, customerAddress,
                productName, qty, sell, cost, profit, method,
                date: new Date().toLocaleDateString('ar-EG')
            });

            localStorage.setItem('tabbed_business_orders', JSON.stringify(orders));
            e.target.reset();
            renderAll();
            showToast('تم حفظ العملية بالكامل');
            showTab('customer-tab'); // Reset to first tab
        };

        function deleteOrder(id) {
            if(confirm('سيتم حذف هذا السجل نهائياً. موافق؟')) {
                orders = orders.filter(o => o.id !== id);
                localStorage.setItem('tabbed_business_orders', JSON.stringify(orders));
                renderAll();
                showToast('تم الحذف');
            }
        }

        function renderAll() {
            renderTable();
            renderStats();
            renderChart();
            lucide.createIcons();
        }

        function renderTable(filter = "") {
            const body = document.getElementById('orders-table-body');
            body.innerHTML = '';
            
            const filtered = orders.filter(o => 
                o.productName.toLowerCase().includes(filter.toLowerCase()) || 
                o.customerName.toLowerCase().includes(filter.toLowerCase())
            );

            if (filtered.length === 0) {
                body.innerHTML = `<tr><td colspan="6" class="p-16 text-center text-slate-600">لا توجد نتائج مطابقة</td></tr>`;
                return;
            }

            filtered.forEach(o => {
                const tr = document.createElement('tr');
                tr.className = "hover:bg-slate-800/40 transition text-sm group";
                tr.innerHTML = `
                    <td class="p-4">
                        <div class="font-bold text-blue-400 mb-0.5 flex items-center gap-1">
                            <i data-lucide="user" class="w-3 h-3"></i> ${o.customerName}
                        </div>
                        <div class="text-xs text-slate-200 font-semibold flex items-center gap-1">
                            <i data-lucide="package" class="w-3 h-3 text-emerald-400"></i> ${o.productName}
                        </div>
                        <div class="text-[10px] text-slate-500 mt-1">${o.date}</div>
                    </td>
                    <td class="p-4">
                        <div class="text-xs text-slate-300 flex items-center gap-1 mb-1">
                             <i data-lucide="phone" class="w-3 h-3 text-blue-500"></i> ${o.customerPhone || 'N/A'}
                        </div>
                        <div class="text-[10px] text-slate-500 truncate max-w-[140px]" title="${o.customerAddress}">
                             <i data-lucide="map-pin" class="w-2.5 h-2.5 inline"></i> ${o.customerAddress || 'بدون عنوان'}
                        </div>
                    </td>
                    <td class="p-4 text-center font-mono font-bold">${o.qty}</td>
                    <td class="p-4">
                        <div class="font-bold ${o.profit >= 0 ? 'text-green-400' : 'text-red-400'}">${o.profit.toLocaleString()} ج.م</div>
                        <div class="text-[9px] text-slate-500 uppercase tracking-tighter">صافي الربح</div>
                    </td>
                    <td class="p-4">
                        <span class="px-2 py-1 rounded text-[9px] font-black uppercase ${o.method === 'Instapay' ? 'bg-purple-500/10 text-purple-500 border border-purple-500/20' : 'bg-orange-500/10 text-orange-500 border border-orange-500/20'}">
                            ${o.method}
                        </span>
                    </td>
                    <td class="p-4">
                        <button onclick="deleteOrder(${o.id})" class="text-slate-600 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100 p-2">
                            <i data-lucide="trash" class="w-4 h-4"></i>
                        </button>
                    </td>
                `;
                body.appendChild(tr);
            });
            lucide.createIcons();
        }

        function renderStats() {
            const totalProfit = orders.reduce((s, o) => s + o.profit, 0);
            const instapay = orders.filter(o => o.method === 'Instapay').reduce((s, o) => s + (o.sell * o.qty), 0);
            const cash = orders.filter(o => o.method === 'Cash').reduce((s, o) => s + (o.sell * o.qty), 0);

            document.getElementById('stat-total-orders').innerText = orders.length;
            document.getElementById('stat-total-profit').innerText = totalProfit.toLocaleString() + ' ج.م';
            document.getElementById('stat-instapay').innerText = instapay.toLocaleString() + ' ج.م';
            document.getElementById('stat-cash').innerText = cash.toLocaleString() + ' ج.م';
        }

        function renderChart() {
            const ctx = document.getElementById('profitChart');
            if(orders.length === 0) {
                ctx.classList.add('hidden');
                document.getElementById('no-data-chart').classList.remove('hidden');
                return;
            }
            ctx.classList.remove('hidden');
            document.getElementById('no-data-chart').classList.add('hidden');

            const profits = {};
            orders.forEach(o => profits[o.productName] = (profits[o.productName] || 0) + o.profit);
            const sorted = Object.entries(profits).sort((a,b) => b[1]-a[1]).slice(0, 5);
            
            if(chart) chart.destroy();
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(s => s[0]),
                    datasets: [{
                        label: 'الربح',
                        data: sorted.map(s => s[1]),
                        backgroundColor: '#3b82f6',
                        borderRadius: 6,
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { grid: { color: '#1e293b' }, ticks: { color: '#64748b', font: { family: 'Cairo' } } },
                        y: { grid: { display: false }, ticks: { color: '#cbd5e1', font: { family: 'Cairo', size: 11 } } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        document.getElementById('search-bar').oninput = (e) => renderTable(e.target.value);

        function exportData() {
            const blob = new Blob([JSON.stringify(orders, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Store_Report_${new Date().toLocaleDateString('ar-EG').replace(/\//g,'-')}.json`;
            a.click();
        }

        function clearAllData() {
            if(confirm('هل أنت متأكد؟ سيتم حذف كل البيانات نهائياً!')) {
                orders = [];
                localStorage.removeItem('tabbed_business_orders');
                renderAll();
            }
        }

        window.onload = init;
    </script>
</body>
</html>